# PRD-0002 — IV Percentile 告警（Massive.com，美股期权）

> 目的：本文件用于把需求“聊清楚”，形成一致的项目范围、优先级与验收标准；**不涉及代码实现**。  
> 状态：已冻结（MVP 口径）  
> 最后更新：2026-01-29
> 前置依赖：`PRD-0001` 实时行情 / 数据观察（Web Terminal 基座能力）

---

## 1. 项目一句话

- 我们要做的是：**一个交易助手，通过 `Massive.com` 的 API 获取美股期权数据，持续追踪关注标的的期权隐含波动率（IV），当 IV 偏高时发出提示/推送，用于辅助交易决策。**

## 2. 背景与动机

- 现状/痛点：
  - 1) 期权 IV 是重要的交易参考，但手工逐个查看/对比成本高，容易错过“IV 异常偏高”的窗口。
  - 2) 需要一个可持续运行的工具，帮我在关注列表内自动监控并提醒。
- 为什么现在做：先从单一指标（IV 提示）切入，快速定义产品形态与迭代路径。
- 不做的代价：继续依赖手工检查，信息延迟导致机会成本增加。

## 3. 目标与非目标

### 3.1 目标（可量化）

- G1：能够通过 `Massive.com` 拉取期权 IV 相关数据，并对关注列表进行自动监控。
- G2：当 IV 触发规则时，能在合理延迟内（15 分钟级）发出提醒，且避免重复刷屏。
- G3：形成可迭代的产品骨架（配置、监控、告警、基础可视化），为后续复杂功能打底。

### 3.2 非目标（明确不做）

- NG1：MVP 阶段不做自动下单、不直接连接券商账户。
- NG2：MVP 阶段不做“给出完整交易策略/收益承诺”，只做指标监控与提醒（可扩展到解释/参考信息）。

## 4. 用户与使用场景

### 4.1 用户画像

- 主要用户（Primary）：我（交易者）
  - 交易品种：美股股票期权
  - 周期：偏中短周期（更多依赖波动率指标做决策）
  - 使用环境：开发阶段 macOS；主要运行环境 Linux

### 4.2 典型场景（按频率排序）

1. 场景A：盘中/盘前我关注一批标的时，我想自动看到哪些标的的期权 IV 偏高，以便快速决定是否进一步分析/构建期权策略。
2. 场景B：我不盯盘时，我想在 IV 异常时收到推送，以便及时回到屏幕查看细节。

## 5. 核心流程（端到端）

### 5.1 今日流程（MVP）

1) 用户配置 `Massive.com` API Key、关注标的列表（watchlist）、监控规则  
2) 系统按设定频率从 `Massive.com` 拉取相关期权数据（期权链/合约 IV 或聚合后的代表性 IV）  
3) 系统对每个标的计算/汇总 IV 指标，并与规则比较  
4) 若触发：在 Web 页面内提示 +（可选）飞书/Email 推送，并给出触发原因与关键字段  
5) 用户打开告警详情（标的、到期、行权价、IV、时间戳等），再自行做进一步判断与交易操作（在外部平台）  
6) （可选）记录告警历史与简单统计，便于回看/调整阈值

### 5.2 未来流程（非MVP）

- 增加 IV Rank / IV Percentile、波动率曲面、与历史/同业对比
- 加入多指标组合告警（价格、成交量、偏度/skew、期限结构 term structure）
- 接入券商/交易所账户用于仓位视图、下单辅助或半自动化执行（后续评估）

## 6. 功能需求（按优先级）

### 6.1 MVP（必须有）

- F1：作为交易者，我希望配置关注标的与 IV 监控规则，从而自动发现“IV 偏高”的标的
  - 验收：
    - watchlist 规模约 50 个标的；支持用户手动添加/删除/编辑
    - 给定 watchlist 与规则，应用能按固定频率（默认 15 分钟）拉取数据并计算 IV 指标
    - 当任意标的满足触发条件时，产生一条告警记录，并在界面/通知中可见
    - 告警去重（按规则维度）：同一「规则」只推送一次，避免重复刷屏（规则维度定义见 12.2）
- F2：作为交易者，我希望在告警发生后能查看“触发详情”，从而判断告警是否有意义
  - 验收：
    - 告警详情至少包含：标的、触发时间、触发规则、所用 IV 指标值、对应合约筛选条件（如到期范围/代表合约）
    - 能在应用内查看最近 N 条告警（N 有默认值）

### 6.2 Should Have（重要但可延期）

- S1：支持更合理的“IV 偏高”定义（例如 IV Rank / IV Percentile / 相对历史分位数）
- S2：支持更灵活的筛选（DTE 范围、Call/Put、Delta/ATM 附近、成交量/持仓量门槛）
- S3：告警渠道扩展（飞书/Email 的可靠投递、Webhook 等）

### 6.3 Nice to Have（锦上添花）

- N1：基础图表（某标的代表性 IV 的时间序列、告警点标注）
- N2：多 watchlist / 多策略规则模板
- N3：导出与复盘（CSV/JSON，简单统计报表）

## 7. 数据、集成与依赖

### 7.1 数据源

- 行情/期权数据：`Massive.com`（MVP 唯一数据源）
- 账户/成交：MVP 不接入（后续再评估）

### 7.2 下单与交易权限

- 是否需要真实下单：否（MVP）

### 7.3 运行形态

- 形态：**直接做 Web 版**（前端使用 React）
- 部署：MVP 需要可部署的 Web 服务（前端 + 后端/任务调度 + 存储）
- 多设备同步：天然支持（同账号多端访问）

### 7.4 系统架构（MVP 推荐）

> 目标：在线服务“快响应”，离线计算“可重试/可扩展”，并为后续策略/建议能力预留空间。

- 前端（Web）：React
  - 负责：展示告警/历史/详情、配置 watchlist 与规则、展示任务状态
- API（在线服务）：FastAPI
  - 负责：配置与查询（CRUD）、鉴权（如需要）、触发任务（enqueue）
  - 原则：**不在请求链路内做高 CPU 计算**（避免阻塞事件循环/请求）
- Worker（离线计算）：Celery Workers
  - 负责：拉取 `Massive.com` 数据、计算 Percentile/Rank、生成告警、发送飞书/Email、写入数据库
  - 能力：并发、超时、重试、失败隔离
- Broker（任务队列）：Redis（供 Celery 使用）
- Scheduler（定时）：Celery Beat（或独立调度进程）
  - 负责：每 15 分钟投递扫描任务；不要与 API 混在同一进程里
- 存储（建议）：Postgres（MVP 也可先 SQLite，但 Web 多进程/并发下更建议 Postgres）
  - 存：watchlist、规则、告警历史、去重状态、任务运行日志（可选）

### 7.5 部署方式（MVP）

- 形态：单机部署（Linux 一台机器足够支撑 MVP）
- 编排：Docker Compose
  - 典型服务：`frontend` / `api` / `worker` / `beat` / `redis` / `postgres`
  - 原则：`api` 与 `beat/worker` 分离进程（避免 API 被计算任务拖慢）
- 对外入口：
  - 可先直接暴露 `api` 与前端（内网/自用）
  - 若要公网：建议加反向代理（Caddy/Nginx）+ HTTPS
- 迁移路径：后续如需弹性扩缩、任务量上来，再评估迁移到 k8s（非 MVP 范围）

## 8. 交互与界面（先定“信息结构”）

- 首页要回答的问题：
  - Q1：当前 watchlist 里有哪些标的触发了“IV 偏高”？
  - Q2：每个标的的代表性 IV/触发原因是什么？最近一次更新时间？
- 关键页面/视图：
  - 页面A：告警列表（可筛选：标的/时间/规则）
  - 页面B：告警详情（触发原因 + 数据快照）
  - 页面C：设置（API Key、watchlist、规则、刷新频率、告警去重/冷却、通知渠道）
- 通知方式：应用内提示（必做）；可选：飞书 / Email 推送

## 9. 非功能需求（NFR）

- 性能：刷新频率默认 15 分钟（与当前 `Massive.com` 15 分钟延迟套餐匹配）；并关注请求量与成本
- 可靠性：API 失败要可见（错误提示/重试/退避），并避免错误导致持续刷通知
- 安全：
  - `Massive.com` API Key 需安全存储（避免明文散落），最小权限与可一键替换
  - Web 部署需要考虑：账号认证（至少简单登录/访问控制）、服务端密钥保护、HTTPS、基础防刷与审计

## 10. 验收与指标（Definition of Done）

- 交付物：
  - 文档：本 PRD + 使用说明
  - 可运行产物：可部署的 Web 应用（React 前端 + 必要的后端服务）
- MVP 验收清单：
  - [ ] 能配置 `Massive.com` API Key，并成功拉取至少 1 个标的的期权 IV 相关数据
  - [ ] watchlist 监控可用：按设定频率刷新，并在触发条件时产生告警
  - [ ] 告警去重生效：同一「规则维度」只推送一次（见 12.2 去重键定义）
  - [ ] 告警详情可追溯（至少包含关键字段与时间戳）

## 11. 里程碑（建议）

- M0：需求冻结（已完成）
- M1：MVP 可用（日期：待定）
- M2：Beta 内测（日期：待定）
- M3：稳定化与扩展告警渠道（日期：待定）

## 12. 风险与开放问题（当前）

### 12.1 风险

- R1：数据源成本/稳定性
- R2：策略误用导致损失（需要哪些“防呆”）

### 12.2 已冻结（MVP 规则定义）

1) 监控范围：约 50 个标的；watchlist 由用户手动添加/维护  
2) “IV 偏高”的定义：IV Percentile（多窗口，多阈值）  
3) 监控层级：每个标的的“代表性 IV”  
4) 合约筛选：Call/Put 区分；ATM 附近；按到期日自然月分桶（见第 14 条）  
5) 刷新频率：15 分钟  
6) 告警渠道：飞书 / Email / 应用内提醒  
7) 去重规则：按规则维度一次（同一规则只推送一次）  
8) 运行环境：主要 Linux；开发阶段 macOS；MVP 为 Web 应用  
9) `Massive.com`：$29 计划；15 分钟延迟；当前认为无 API 限制（仍需以官方条款为准）  
10) 形态路线：MVP 直接做 Web（React）；核心业务尽量设计为可复用，便于后续扩展与并行开发  
11) IV Percentile 历史窗口：`1M / 3M / 6M / 1Y`（同时计算）  
12) 触发与优先级：
   - 任一窗口达到 `P90`：触发提醒（普通优先级）
   - 任一窗口达到 `P95`：触发提醒（高优先级）
13) 规则维度（去重键）：`(ticker, Call/Put, DTE桶, 历史窗口, 阈值等级[P90|P95])`
   - 同一去重键只推送一次；若先触发 P90，后续同窗口触发 P95，视为不同规则，可再推送一次（高优先级）
14) DTE 分桶（按到期日所属自然月）：
   - `本月到期`：到期日在当前自然月内
   - `3月内到期`：到期日在“含本月起算”的未来 3 个自然月内
   - `半年内到期`：到期日在“含本月起算”的未来 6 个自然月内
